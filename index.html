<!DOCTYPE html><html class="default no-js"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>next-redux-cookie-wrapper - v2.1.0</title><meta name="description" content="Documentation for next-redux-cookie-wrapper - v2.1.0"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="assets/style.css"/><link rel="stylesheet" href="assets/highlight.css"/><script async src="assets/search.js" id="search-script"></script></head><body><header><div class="tsd-page-toolbar"><div class="container"><div class="table-wrap"><div class="table-cell" id="tsd-search" data-base="."><div class="field"><label for="tsd-search-field" class="tsd-widget search no-caption">Search</label><input type="text" id="tsd-search-field"/></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="index.html" class="title">next-redux-cookie-wrapper - v2.1.0</a></div><div class="table-cell" id="tsd-widgets"><div id="tsd-filter"><a href="#" class="tsd-widget options no-caption" data-toggle="options">Options</a><div class="tsd-filter-group"><div class="tsd-select" id="tsd-filter-visibility"><span class="tsd-select-label">All</span><ul class="tsd-select-list"><li data-value="public">Public</li><li data-value="protected">Public/Protected</li><li data-value="private" class="selected">All</li></ul></div> <input type="checkbox" id="tsd-filter-inherited" checked/><label class="tsd-widget" for="tsd-filter-inherited">Inherited</label><input type="checkbox" id="tsd-filter-externals" checked/><label class="tsd-widget" for="tsd-filter-externals">Externals</label></div></div><a href="#" class="tsd-widget menu no-caption" data-toggle="menu">Menu</a></div></div></div></div><div class="tsd-page-title"><div class="container"><h1>next-redux-cookie-wrapper - v2.1.0</h1></div></div></header><div class="container container-main"><div class="row"><div class="col-8 col-content"><div class="tsd-panel tsd-typography">
<a href="#next-redux-cookie-wrapper" id="next-redux-cookie-wrapper" style="color: inherit; text-decoration: none;">
  <h1>next-redux-cookie-wrapper</h1>
</a>
<p><a href="https://www.npmjs.com/package/next-redux-cookie-wrapper"><img src="https://img.shields.io/npm/v/next-redux-cookie-wrapper/latest" alt="npm (tag)"></a>
<a href="https://github.com/bjoluc/next-redux-cookie-wrapper/actions"><img src="https://img.shields.io/github/workflow/status/bjoluc/next-redux-cookie-wrapper/build" alt="GitHub Workflow Status"></a>
<a href="https://codecov.io/gh/bjoluc/next-redux-cookie-wrapper"><img src="https://codecov.io/gh/bjoluc/next-redux-cookie-wrapper/branch/master/graph/badge.svg" alt="codecov"></a>
<a href="http://commitizen.github.io/cz-cli/"><img src="https://img.shields.io/badge/commitizen-friendly-brightgreen.svg" alt="Commitizen friendly"></a>
<a href="https://github.com/xojs/xo"><img src="https://img.shields.io/badge/code_style-XO-5ed9c7.svg" alt="XO code style"></a>
<a href="https://github.com/semantic-release/semantic-release"><img src="https://img.shields.io/badge/%20%20%F0%9F%93%A6%F0%9F%9A%80-semantic--release-e10079.svg" alt="semantic-release"></a></p>
<p>A <a href="https://github.com/kirill-konshin/next-redux-wrapper/">next-redux-wrapper</a> extension to sync a subset of a client&#39;s <a href="https://redux.js.org/">Redux</a> state with cookies such that it survives page reloads and is available to the server during SSR :cookie: :sparkles:</p>

<a href="#motivation" id="motivation" style="color: inherit; text-decoration: none;">
  <h2>Motivation</h2>
</a>
<p>When it comes to Redux state persistence, <a href="https://github.com/rt2zz/redux-persist">Redux Persist</a> is a popular choice.
With Next.js, however, the persisted state is (without further ado) not available during SSR.
Hence, the first render on the client side may largely differ from the server-rendered markup.
A solution to this is a storage method that is available to both the server and the client by default: Cookies.</p>
<p>This library started as a drop-in replacement for <a href="https://github.com/kirill-konshin/next-redux-wrapper/">next-redux-wrapper</a> that built upon Redux Persist and a <a href="https://github.com/abersager/redux-persist-cookie-storage">storage adapter for cookies</a>.
However, in response to <code>getStaticProps()</code> and <code>getServerSideProps()</code> being introduced in Next.js, it has been rewritten and the tooling has been simplified significantly.
What remains is a single Redux middleware and a tiny wrapper around the <code>makeStore()</code> function.</p>

<a href="#how-does-it-work" id="how-does-it-work" style="color: inherit; text-decoration: none;">
  <h2>How does it work?</h2>
</a>
<p>On the server, a wrapper around <code>makeStore()</code> passes the Next.js context to the middleware via an action.
The middleware then reads the cookies and dispatches an initial <code>HYDRATE</code> action with the client&#39;s state.
On server-side state changes, <code>set-cookie</code> headers are set to update the client&#39;s cookies.</p>
<p>Similarly, the client updates cookies whenever a relevant portion of the state changes.
Moreover, the <code>HYDRATE</code> action is intercepted on the client and the configured state subtrees are (by default) parsed from the cookies instead of the retrieved JSON data.
This way, incoming state updates from <code>getStaticProps()</code> do not overwrite the synced state subtrees as <code>getStaticProps()</code> does not update the cookies.
You can opt out of this behavior on a per-state-subtree basis and instead always receive the server&#39;s state in the <code>HYDRATE</code> reducer if you wish to handle state portions from <code>getStaticProps()</code> on your own.</p>
<p>Some words about compression:
By default, the serialized cookie state is compressed using <a href="https://github.com/pieroxy/lz-string">lz-string</a> to keep the cookie size small.
You can disable compression globally or per state subtree by setting the <code>compress</code> option to <code>false</code>.</p>

<a href="#setup" id="setup" style="color: inherit; text-decoration: none;">
  <h2>Setup</h2>
</a>
<blockquote>
<p><strong>TL;DR</strong></p>
<p>For a quick working example, check out the demo project in this repository.
It uses <a href="https://redux-toolkit.js.org/">Redux Toolkit</a> but that should not discourage you.</p>
<ul>
<li>Clone the repository</li>
<li>Make sure you have npm 7 installed (<code>npm i -g npm@7</code>; required for the workspaces feature)</li>
<li>Run <code>npm install</code> in the root directory</li>
<li><code>cd demo &amp;&amp; npm start</code></li>
<li>Inspect the setup in <a href="https://github.com/bjoluc/next-redux-cookie-wrapper/tree/main/demo/store.ts"><code>store.ts</code></a></li>
</ul>
</blockquote>
<p>If you do not have next-redux-wrapper set up, follow their <a href="https://github.com/kirill-konshin/next-redux-wrapper/#installation">installation instructions</a>.
Afterwards, install <code>next-redux-cookie-wrapper</code>:</p>
<pre><code><span class="hl-6">npm</span><span class="hl-1"> </span><span class="hl-6">install</span><span class="hl-1"> --</span><span class="hl-6">save</span><span class="hl-1"> </span><span class="hl-6">next</span><span class="hl-1">-</span><span class="hl-6">redux</span><span class="hl-1">-</span><span class="hl-6">cookie</span><span class="hl-1">-</span><span class="hl-6">wrapper</span>
</code></pre>
<p>and configure your store to use <code>nextReduxCookieMiddleware</code> by passing it to <code>createStore()</code> and wrapping your <code>makeStore()</code> function with <code>wrapMakeStore()</code>:</p>
<pre><code class="language-diff"><span class="hl-7">+ import {nextReduxCookieMiddleware, wrapMakeStore} from &quot;next-redux-cookie-wrapper&quot;;</span><br/><br/><span class="hl-1">...</span><br/><br/><span class="hl-8">- const makeStore = () =&gt; createStore(reducer);</span><br/><span class="hl-7">+ const makeStore = wrapMakeStore(() =&gt;</span><br/><span class="hl-7">+   createStore(</span><br/><span class="hl-7">+     reducer,</span><br/><span class="hl-7">+     applyMiddleware(</span><br/><span class="hl-7">+       nextReduxCookieMiddleware({</span><br/><span class="hl-7">+         subtrees: [&quot;my.subtree&quot;],</span><br/><span class="hl-7">+       })</span><br/><span class="hl-7">+     )</span><br/><span class="hl-7">+   )</span><br/><span class="hl-7">+ );</span>
</code></pre>
<p>That&#39;s it! The state of <code>my.subtree</code> should now be synced with a cookie called <code>my.subtree</code> and available on the server during SSR.
If not, you can set the debug flag of <code>next-redux-wrapper</code> to <code>true</code> to get some insights on the state:</p>
<pre><code class="language-ts"><span class="hl-0">export</span><span class="hl-1"> </span><span class="hl-2">const</span><span class="hl-1"> </span><span class="hl-3">wrapper</span><span class="hl-1"> = </span><span class="hl-4">createWrapper</span><span class="hl-1">&lt;</span><span class="hl-5">AppStore</span><span class="hl-1">&gt;(</span><span class="hl-6">makeStore</span><span class="hl-1">, {</span><span class="hl-6">debug:</span><span class="hl-1"> </span><span class="hl-2">true</span><span class="hl-1">});</span>
</code></pre>

<a href="#usage-with-redux-toolkit" id="usage-with-redux-toolkit" style="color: inherit; text-decoration: none;">
  <h3>Usage with Redux Toolkit</h3>
</a>
<p>When using <a href="https://redux-toolkit.js.org/">Redux Toolkit</a>, it is important that <code>nextReduxCookieMiddleware</code> is used before any of the default middlewares:</p>
<pre><code class="language-ts"><span class="hl-2">const</span><span class="hl-1"> </span><span class="hl-3">makeStore</span><span class="hl-1"> = </span><span class="hl-4">wrapMakeStore</span><span class="hl-1">(() </span><span class="hl-2">=&gt;</span><br/><span class="hl-1">  </span><span class="hl-4">configureStore</span><span class="hl-1">({</span><br/><span class="hl-1">    </span><span class="hl-6">reducer:</span><span class="hl-1"> {...},</span><br/><span class="hl-1">    </span><span class="hl-4">middleware</span><span class="hl-6">:</span><span class="hl-1"> (</span><span class="hl-6">getDefaultMiddleware</span><span class="hl-1">) </span><span class="hl-2">=&gt;</span><br/><span class="hl-1">      </span><span class="hl-4">getDefaultMiddleware</span><span class="hl-1">().</span><span class="hl-4">prepend</span><span class="hl-1">(</span><br/><span class="hl-1">        </span><span class="hl-4">nextReduxCookieMiddleware</span><span class="hl-1">({</span><br/><span class="hl-1">          </span><span class="hl-6">subtrees:</span><span class="hl-1"> [</span><span class="hl-8">&quot;my.subtree&quot;</span><span class="hl-1">],</span><br/><span class="hl-1">        })</span><br/><span class="hl-1">      ),</span><br/><span class="hl-1">  })</span><br/><span class="hl-1">);</span>
</code></pre>
<p>The reason for this is that Redux Toolkit by default adds a <a href="https://redux-toolkit.js.org/api/serializabilityMiddleware">serializability middleware</a> that would complain about the <code>SERVE_COOKIES</code> action which <code>wrapMakeStore()</code> uses to pass the Next.js context to <code>nextReduxCookieMiddleware</code>.
When <code>nextReduxCookieMiddleware</code> is invoked before the serializability middleware, it catches the <code>SERVE_COOKIES</code> action before it reaches that middleware.
Alternatively, you can also configure the serializability middleware to ignore the <code>SERVE_COOKIES</code> action, should you prefer that.</p>

<a href="#configuration" id="configuration" style="color: inherit; text-decoration: none;">
  <h2>Configuration</h2>
</a>
<p>For the configuration options of <code>nextReduxCookieMiddleware</code>, please refer to <a href="https://next-redux-cookie-wrapper.js.org/interfaces/NextReduxCookieMiddlewareConfig.html">the API documentation</a>.</p>
</div></div><div class="col-4 col-menu menu-sticky-wrap menu-highlight"><nav class="tsd-navigation primary"><ul><li class="current"><a href="modules.html">Exports</a></li></ul></nav><nav class="tsd-navigation secondary menu-sticky"><ul><li class="tsd-kind-interface"><a href="interfaces/NextReduxCookieMiddlewareConfig.html" class="tsd-kind-icon">Next<wbr/>Redux<wbr/>Cookie<wbr/>Middleware<wbr/>Config</a></li><li class="tsd-kind-interface"><a href="interfaces/SubtreeConfig.html" class="tsd-kind-icon">Subtree<wbr/>Config</a></li><li class="tsd-kind-variable"><a href="modules.html#SERVE_COOKIES" class="tsd-kind-icon">SERVE_<wbr/>COOKIES</a></li><li class="tsd-kind-function"><a href="modules.html#nextReduxCookieMiddleware" class="tsd-kind-icon">next<wbr/>Redux<wbr/>Cookie<wbr/>Middleware</a></li><li class="tsd-kind-function tsd-has-type-parameter"><a href="modules.html#wrapMakeStore" class="tsd-kind-icon">wrap<wbr/>Make<wbr/>Store</a></li></ul></nav></div></div></div><footer class="with-border-bottom"><div class="container"><h2>Legend</h2><div class="tsd-legend-group"><ul class="tsd-legend"><li class="tsd-kind-property tsd-parent-kind-interface"><span class="tsd-kind-icon">Property</span></li></ul></div><h2>Settings</h2><p>Theme <select id="theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></p></div></footer><div class="container tsd-generator"><p>Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></div><div class="overlay"></div><script src="assets/main.js"></script></body></html>